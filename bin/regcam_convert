#!/bin/sh -e

SRC=$1
DST=$2

help() {
    echo "Usage: $0 source_dir output_file"
    exit 1
}

[ "x$SRC" = "x" ] && help
[ "x$DST" = "x" ] && help
test -d "$SRC" || help
DST=`echo "$DST" | grep -q '.webm$' && echo "$DST" || echo "$DST.webm"`
test -d `dirname "$DST"` || help
test -f "$DST" && help

echo "Destination: '$DST'"
sleep 1

set -x

FILES=`ls "$SRC" | grep -e '[0-9]\+_[0-9]\+_[0-9]\+_[0-9]\+.mp4' | sed 's/\.mp4$//'`

DIR=`mktemp -d`
for f in $FILES; do
    cp "$SRC/$f.mp4" "$DIR/$f.mp4"
    cp "$SRC/$f.srt" "$DIR/$f.srt"
done

cd "$DIR"

for f in $FILES; do
    mencoder $f.mp4 -vf "rotate=1"\
        -sub $f.srt \
        -ovc lavc -lavcopts vcodec=mpeg4:vbitrate=15000000 \
        -o $f.sub.mp4
done

mencoder -o all.mp4 -ovc lavc -lavcopts vcodec=mpeg4:vbitrate=15000000 *.sub.mp4

avconv -i all.mp4 -f webm -pre libvpx-720p all.webm

cd -
mv "$DIR/all.webm" "$DST"
rm -rf "$DIR"
